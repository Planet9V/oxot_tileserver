# Backup & Restore

> **Last Updated**: 2026-02-11 01:00 UTC

[Home](INDEX.md) > [Operations & Maintenance](08-OPERATIONS.md) > Backup & Restore

---

## Overview

The OXOT Tileserver stores all state on disk in three locations: tile files, configuration files, and style definitions. There is no database. Backup and restore is a file copy operation. This page documents what to back up, how to automate backups, and how to restore from a backup.

---

## What to Back Up

| Directory | Contents | Priority | Size |
|-----------|----------|----------|------|
| `data/tiles/` | `.mbtiles` and `.pmtiles` tile files | High | 2--40 GB depending on install option |
| `config/` | `tileserver-config.json` | High | < 1 KB |
| `data/styles/` | Style JSON files (e.g., `infrastructure.json`) | High | < 10 KB |
| `data/raw/` | Downloaded source data | Low | 10--80 GB (re-downloadable) |
| `data/extracted/` | Intermediate GeoJSON | Low | 5--30 GB (regenerable from raw) |
| `.env` | Environment configuration | High | < 1 KB |
| `docker-compose.yml` | Container orchestration | High | < 2 KB |

**Minimum backup set**: `data/tiles/`, `config/`, `data/styles/`, `.env`, `docker-compose.yml`

The `data/raw/` and `data/extracted/` directories can be regenerated by re-running the download and conversion pipeline. Back them up only if re-downloading is impractical (slow network, rate-limited APIs, or API key constraints).

---

## Backup Script

```bash
#!/bin/bash
# backup-tileserver.sh
# Creates a dated backup of all essential tileserver files

set -euo pipefail

BACKUP_DIR="${BACKUP_DIR:-/backups/tileserver}"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="tileserver_backup_${DATE}"
BACKUP_PATH="${BACKUP_DIR}/${BACKUP_NAME}"

echo "Creating backup: ${BACKUP_PATH}"
mkdir -p "${BACKUP_PATH}"

# Copy tile files
echo "Backing up tile files..."
cp -a data/tiles/ "${BACKUP_PATH}/tiles/"

# Copy configuration
echo "Backing up configuration..."
cp -a config/ "${BACKUP_PATH}/config/"

# Copy styles
echo "Backing up styles..."
if [ -d data/styles ]; then
  cp -a data/styles/ "${BACKUP_PATH}/styles/"
fi

# Copy environment and compose
echo "Backing up environment files..."
cp .env "${BACKUP_PATH}/.env" 2>/dev/null || true
cp docker-compose.yml "${BACKUP_PATH}/docker-compose.yml" 2>/dev/null || true

# Create checksum manifest
echo "Generating checksums..."
find "${BACKUP_PATH}" -type f -exec shasum -a 256 {} \; > "${BACKUP_PATH}/checksums.sha256"

# Calculate total size
TOTAL_SIZE=$(du -sh "${BACKUP_PATH}" | cut -f1)
echo "Backup complete: ${BACKUP_PATH} (${TOTAL_SIZE})"

# Optional: compress
# tar czf "${BACKUP_PATH}.tar.gz" -C "${BACKUP_DIR}" "${BACKUP_NAME}"
# rm -rf "${BACKUP_PATH}"
# echo "Compressed: ${BACKUP_PATH}.tar.gz"
```

### Scheduled Backups

Add to cron for automated weekly backups:

```bash
# Run backup every Sunday at 2 AM
0 2 * * 0 /path/to/backup-tileserver.sh >> /var/log/tileserver-backup.log 2>&1
```

---

## Restore Procedure

### Step 1: Stop the Tileserver

```bash
docker compose down tileserver
```

### Step 2: Restore Files

```bash
BACKUP_PATH="/backups/tileserver/tileserver_backup_20260210_020000"

# Restore tile files
cp -a "${BACKUP_PATH}/tiles/"* data/tiles/

# Restore configuration
cp -a "${BACKUP_PATH}/config/"* config/

# Restore styles
if [ -d "${BACKUP_PATH}/styles" ]; then
  cp -a "${BACKUP_PATH}/styles/"* data/styles/
fi

# Restore environment
cp "${BACKUP_PATH}/.env" .env 2>/dev/null || true
```

### Step 3: Verify Checksums

```bash
cd "${BACKUP_PATH}"
shasum -a 256 -c checksums.sha256
```

### Step 4: Start the Tileserver

```bash
docker compose up -d tileserver

# Verify health
sleep 5
curl -s http://localhost:8080/health

# Verify tilesets loaded
curl -s http://localhost:8080/index.json | jq '.tilesets | length'
```

---

## Versioning Tile Files

When regenerating tiles from updated source data, use a date suffix to version tile files before overwriting:

```bash
# Before conversion, rename existing tile file
DATE=$(date +%Y%m%d)
mv data/tiles/osm-infrastructure.mbtiles "data/tiles/osm-infrastructure_${DATE}.mbtiles"

# Run conversion (creates new osm-infrastructure.mbtiles)
docker compose run converter ./scripts/convert.sh --source osm-power

# Verify new tiles work
docker compose restart tileserver
curl -s http://localhost:8080/health

# If verification passes, delete old version
rm "data/tiles/osm-infrastructure_${DATE}.mbtiles"
```

This approach provides a rollback path: if the new tiles have issues, rename the dated file back to the original name and restart.

---

## Backup Rotation

Retain a limited number of backups to prevent disk exhaustion:

```bash
#!/bin/bash
# rotate-backups.sh
# Keep only the 4 most recent backups

BACKUP_DIR="/backups/tileserver"
KEEP=4

ls -dt "${BACKUP_DIR}"/tileserver_backup_* 2>/dev/null | tail -n +$((KEEP + 1)) | while read dir; do
  echo "Removing old backup: ${dir}"
  rm -rf "${dir}"
done
```

---

## Disaster Recovery

For complete disaster recovery (new machine, lost Docker volumes):

1. Install Docker and Docker Compose.
2. Clone the repository or restore `docker-compose.yml` and `.env`.
3. Restore tile files, config, and styles from backup.
4. Run `docker compose build` (rebuild images).
5. Run `docker compose up -d tileserver`.
6. Verify with health check and tileset listing.

If no backup is available, re-run the full data pipeline:

```bash
docker compose run converter ./scripts/download.sh --all
docker compose run converter ./scripts/convert.sh --all
docker compose up -d tileserver
```

This regenerates all tiles from source data. Duration depends on network speed and install option (Option E may take several hours).

---

## Related Pages

- [Operations & Maintenance](08-OPERATIONS.md) -- parent page
- [Health & Monitoring](08a-MONITORING.md) -- verifying restore success
- [Updates & Scheduling](04e-MAINTENANCE.md) -- scheduling tile data updates
- [Installation Options A-E](03b-OPTIONS.md) -- understanding data scope per option

---

*[Home](INDEX.md) | [Operations](08-OPERATIONS.md) | [Monitoring](08a-MONITORING.md) | [Troubleshooting](08b-TROUBLESHOOTING.md) | [Performance](08c-PERFORMANCE.md)*
